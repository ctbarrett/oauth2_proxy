resource_types:
  - name: pull-request
    type: docker-image
    source:
      repository: jtarchie/pr

jobs:
- name: build-pr
  plan:
  - get: pull-request
    trigger: true
    version: every
  - put: pr-status-pending
    resource: pull-request
    params: { path: pull-request, status: pending }

  - get: oauth2_proxy

  - task: go-build
    file: pull-request/ci/build.yaml
    on_failure:
      put: pr-status-failed
      resource: pull-request
      params: { path: pull-request, status: failure }

  - put: build-docker-image
    params: { build: pull-request, tag: pull-request/VERSION }

  - put: pr-status-success
    resource: pull-request
    params: { path: pull-request, status: success }

resources:
  - name: pull-request
    type: pull-request
    source:
      uri: git@github.com:getoutreach/oauth2_proxy.git
      access_token: ((github-access-token))
      private_key: ((git-private-key))
      repo: getoutreach/oauth2_proxy

  - name: oauth2_proxy
    type: git
    source:
      uri: https://github.com/bitly/oauth2_proxy.git
      branch: master

  - name: build-docker-image
    type: docker-image
    source:
      repository: 182192988802.dkr.ecr.us-west-2.amazonaws.com/oauth2_proxy
      parameters: { build: pull-request, tag: pull-request/VERSION }
